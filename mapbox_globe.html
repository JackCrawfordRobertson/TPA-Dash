<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Global Payments 3D Globe</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #28313E;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(50, 61, 77, 0.95);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1;
            font-size: 13px;
            max-width: 280px;
            border: 1px solid #4A5668;
        }
        .legend h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
        }
        .legend-scale {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .legend-label {
            font-size: 12px;
            color: #D1D5DB;
        }
        .tooltip {
            position: absolute;
            background: rgba(40, 49, 62, 0.98);
            color: #fff;
            padding: 16px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 2;
            border: 1px solid #01D6B0;
            backdrop-filter: blur(10px);
            max-width: 300px;
            display: none;
            box-shadow: 0 4px 12px rgba(1, 214, 176, 0.2);
        }
        .tooltip-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 12px;
            color: #01D6B0;
            border-bottom: 2px solid #01D6B0;
            padding-bottom: 8px;
        }
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding: 6px 0;
            color: #E0E0E0;
        }
        .tooltip-year {
            color: #9CA3AF;
            font-weight: 500;
            min-width: 45px;
        }
        .tooltip-value {
            font-weight: 600;
            color: #01D6B0;
            text-align: right;
            min-width: 100px;
        }
        .controls {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(50, 61, 77, 0.95);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1;
            font-size: 12px;
            color: #E0E0E0;
            border: 1px solid #4A5668;
        }
        .controls h4 {
            margin: 0 0 10px 0;
            font-size: 13px;
            font-weight: 600;
            color: #FFFFFF;
        }
        .controls p {
            margin: 5px 0;
            color: #9CA3AF;
            font-size: 11px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 49, 62, 0.95);
            color: #FFFFFF;
            padding: 30px;
            border-radius: 8px;
            z-index: 10;
            text-align: center;
            border: 1px solid #4A5668;
        }
        .info-box {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(50, 61, 77, 0.95);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1;
            font-size: 13px;
            color: #E0E0E0;
            border: 1px solid #4A5668;
            max-width: 300px;
        }
        .info-box h4 {
            margin: 0 0 8px 0;
            color: #01D6B0;
            font-weight: 600;
        }
        .info-box p {
            margin: 5px 0;
            font-size: 12px;
            color: #9CA3AF;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="tooltip" id="tooltip">
    <div class="tooltip-title" id="tooltip-country"></div>
    <div id="tooltip-data"></div>
</div>

<div class="info-box">
    <h4>Global Payment Values 2025</h4>
    <p>Color intensity shows transaction value by country</p>
    <p style="margin-top: 10px; font-size: 11px; color: #4A5668;">Darker teal = Lower value</p>
    <p style="margin-top: 2px; font-size: 11px; color: #4A5668;">Brighter teal = Higher value</p>
</div>

<div class="legend">
    <h3>Transaction Value Scale (USD)</h3>
    <div id="legend-content"></div>
</div>

<div class="controls">
    <h4>3D Globe Controls</h4>
    <p>üñ±Ô∏è Drag to rotate</p>
    <p>üîç Scroll to zoom</p>
    <p>Hover over countries for details</p>
</div>

<div class="loading" id="loading">
    <p>Loading 3D globe...</p>
</div>

<script>
    // Mapbox API key
    mapboxgl.accessToken = 'pk.eyJ1IjoidHBhLXZpeiIsImEiOiJjbWhtNXE0NmowandvMmlxazQ0NTNtaGRpIn0.aN_mnCiCV54rcFjRW7GNYw';

    // Payment data for 2025 and historical data (in billions USD)
    const paymentData = {
        "United States": { "2021": 2100, "2022": 2250, "2023": 2400, "2024": 2500, "2025": 2650 },
        "China": { "2021": 450, "2022": 520, "2023": 600, "2024": 680, "2025": 780 },
        "Japan": { "2021": 380, "2022": 395, "2023": 410, "2024": 425, "2025": 445 },
        "United Kingdom": { "2021": 185, "2022": 195, "2023": 208, "2024": 220, "2025": 235 },
        "Germany": { "2021": 165, "2022": 172, "2023": 182, "2024": 195, "2025": 210 },
        "France": { "2021": 145, "2022": 150, "2023": 158, "2024": 168, "2025": 180 },
        "India": { "2021": 85, "2022": 105, "2023": 130, "2024": 160, "2025": 195 },
        "Canada": { "2021": 95, "2022": 102, "2023": 110, "2024": 120, "2025": 132 },
        "Australia": { "2021": 65, "2022": 70, "2023": 76, "2024": 85, "2025": 95 },
        "Brazil": { "2021": 58, "2022": 62, "2023": 68, "2024": 75, "2025": 85 },
        "Mexico": { "2021": 42, "2022": 46, "2023": 52, "2024": 60, "2025": 72 },
        "South Korea": { "2021": 78, "2022": 82, "2023": 88, "2024": 95, "2025": 105 },
        "Singapore": { "2021": 48, "2022": 52, "2023": 58, "2024": 65, "2025": 75 },
        "Hong Kong": { "2021": 52, "2022": 56, "2023": 61, "2024": 68, "2025": 78 },
        "Netherlands": { "2021": 68, "2022": 73, "2023": 80, "2024": 90, "2025": 102 },
        "Spain": { "2021": 55, "2022": 59, "2023": 64, "2024": 72, "2025": 82 },
        "Italy": { "2021": 48, "2022": 51, "2023": 56, "2024": 63, "2025": 72 },
        "Switzerland": { "2021": 62, "2022": 66, "2023": 72, "2024": 80, "2025": 90 },
        "Sweden": { "2021": 35, "2022": 38, "2023": 42, "2024": 48, "2025": 55 },
        "Norway": { "2021": 28, "2022": 31, "2023": 35, "2024": 40, "2025": 47 },
        "Russia": { "2021": 35, "2022": 32, "2023": 28, "2024": 25, "2025": 22 },
        "UAE": { "2021": 32, "2022": 38, "2023": 48, "2024": 62, "2025": 80 },
        "Indonesia": { "2021": 22, "2022": 28, "2023": 36, "2024": 48, "2025": 65 },
        "Thailand": { "2021": 18, "2022": 22, "2023": 28, "2024": 38, "2025": 52 },
        "Philippines": { "2021": 15, "2022": 19, "2023": 26, "2024": 36, "2025": 52 },
        "Turkey": { "2021": 28, "2022": 26, "2023": 24, "2024": 22, "2025": 20 },
        "South Africa": { "2021": 18, "2022": 20, "2023": 22, "2024": 25, "2025": 28 },
        "Nigeria": { "2021": 8, "2022": 12, "2023": 18, "2024": 25, "2025": 35 }
    };

    // Initialize map
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [0, 20],
        zoom: 1.2,
        pitch: 30,
        bearing: 0,
        projection: 'globe',
        minZoom: 0.5,
        maxZoom: 4
    });

    // Keep globe centered when zooming
    map.on('zoom', function() {
        if (Math.abs(map.getCenter().lng) > 10 || Math.abs(map.getCenter().lat) > 30) {
            map.setCenter([0, 20]);
        }
    });

    let geoJsonData = null;
    const countryDataMap = new Map();

    // Country name mapping for GeoJSON
    const countryNameMap = {
        "United States of America": "United States",
        "Russia": "Russia",
        "China": "China",
        "Canada": "Canada",
        "Brazil": "Brazil",
        "Australia": "Australia",
        "India": "India",
        "United Kingdom": "United Kingdom",
        "Germany": "Germany",
        "France": "France",
        "Japan": "Japan",
        "Mexico": "Mexico",
        "South Korea": "South Korea",
        "Republic of Korea": "South Korea",
        "Spain": "Spain",
        "Italy": "Italy",
        "Netherlands": "Netherlands",
        "Switzerland": "Switzerland",
        "Sweden": "Sweden",
        "Norway": "Norway",
        "Turkey": "Turkey",
        "United Arab Emirates": "UAE",
        "Indonesia": "Indonesia",
        "Thailand": "Thailand",
        "Philippines": "Philippines",
        "South Africa": "South Africa",
        "Nigeria": "Nigeria",
        "Hong Kong": "Hong Kong",
        "Singapore": "Singapore"
    };

    // Interpolate color between two hex colors
    function interpolateColor(color1, color2, factor) {
        const c1 = parseInt(color1.slice(1), 16);
        const c2 = parseInt(color2.slice(1), 16);

        const r = Math.round(((c1 >> 16) & 255) * (1 - factor) + ((c2 >> 16) & 255) * factor);
        const g = Math.round(((c1 >> 8) & 255) * (1 - factor) + ((c2 >> 8) & 255) * factor);
        const b = Math.round((c1 & 255) * (1 - factor) + (c2 & 255) * factor);

        return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    // Get color based on value (low: #006B5F dark teal, high: #01D6B0 bright teal)
    function getColorForValue(value, min, max) {
        const darkTeal = '#006B5F';  // Low value
        const brightTeal = '#01D6B0'; // High value

        if (max === min) {
            return brightTeal;
        }

        const normalized = (value - min) / (max - min);
        return interpolateColor(darkTeal, brightTeal, normalized);
    }

    // Load GeoJSON country boundaries from alternative source
    async function loadGeoJson() {
        try {
            console.log('Loading GeoJSON from alternative source...');
            const response = await fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson');

            if (!response.ok) {
                throw new Error('Failed to fetch GeoJSON');
            }

            geoJsonData = await response.json();

            // Find min/max values for color scaling
            let minValue = Infinity;
            let maxValue = 0;

            Object.values(paymentData).forEach(data => {
                const val = data['2025'];
                minValue = Math.min(minValue, val);
                maxValue = Math.max(maxValue, val);
            });

            // Assign colors and data to features
            geoJsonData.features.forEach((feature, index) => {
                let countryName = feature.properties.ADMIN || feature.properties.NAME || '';

                // Map country names to our payment data
                if (countryNameMap[countryName]) {
                    countryName = countryNameMap[countryName];
                }

                if (paymentData[countryName]) {
                    const value = paymentData[countryName]['2025'];
                    const color = getColorForValue(value, minValue, maxValue);

                    feature.properties.value = value;
                    feature.properties.color = color;
                    feature.properties.all_data = paymentData[countryName];
                    feature.properties.COUNTRY_NAME = countryName;

                    countryDataMap.set(index, {
                        name: countryName,
                        value: value,
                        color: color,
                        data: paymentData[countryName]
                    });
                } else {
                    feature.properties.value = 0;
                    feature.properties.color = '#4A5668';
                }

                // Add unique ID if not present
                if (feature.id === undefined) {
                    feature.id = index;
                }
            });

            console.log('GeoJSON loaded and processed:', geoJsonData.features.length, 'features');
            console.log('Data countries found:', countryDataMap.size);
            return true;
        } catch (error) {
            console.error('Error loading GeoJSON:', error);
            return false;
        }
    }

    // Create legend with color scale
    function createLegend() {
        const legendContent = document.getElementById('legend-content');
        const scales = [
            { label: '< $100B', color: '#006B5F' },
            { label: '$100B - $300B', color: '#00896D' },
            { label: '$300B - $700B', color: '#00A77C' },
            { label: '$700B - $1.5T', color: '#00C58B' },
            { label: '> $1.5T', color: '#01D6B0' }
        ];

        scales.forEach(scale => {
            const item = document.createElement('div');
            item.className = 'legend-scale';
            item.innerHTML = `
                <div class="legend-color" style="background: ${scale.color}; border: 1px solid rgba(255,255,255,0.2);"></div>
                <span class="legend-label">${scale.label}</span>
            `;
            legendContent.appendChild(item);
        });
    }

    // Format currency
    function formatCurrency(value) {
        if (value >= 1000) {
            return (value / 1000).toFixed(2) + 'T';
        } else if (value >= 1) {
            return value.toFixed(0) + 'B';
        }
        return value.toFixed(0) + 'M';
    }

    // Main initialization
    map.on('load', async function() {
        // Load GeoJSON data
        const success = await loadGeoJson();

        if (!success) {
            document.getElementById('loading').innerHTML = '<p style="color: #00B399;">Error loading map data</p>';
            return;
        }

        // Remove loading indicator
        document.getElementById('loading').style.display = 'none';

        // Add GeoJSON source
        map.addSource('countries', {
            type: 'geojson',
            data: geoJsonData
        });

        // Add fill layer with dynamic colors
        map.addLayer({
            id: 'countries-fill',
            type: 'fill',
            source: 'countries',
            paint: {
                'fill-color': ['coalesce', ['feature-state', 'color'], ['get', 'color']],
                'fill-opacity': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    0.95,
                    0.75
                ]
            }
        });

        // Add outline layer
        map.addLayer({
            id: 'countries-outline',
            type: 'line',
            source: 'countries',
            paint: {
                'line-color': '#FFFFFF',
                'line-width': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    2.5,
                    0.8
                ],
                'line-opacity': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    1,
                    0.2
                ]
            }
        });

        // Create legend
        createLegend();

        // Hover interactions
        const tooltip = document.getElementById('tooltip');
        let hoveredFeatureId = null;

        map.on('mousemove', 'countries-fill', function(e) {
            if (e.features.length > 0) {
                const featureId = e.features[0].id;

                // Reset previous hover
                if (hoveredFeatureId !== null && hoveredFeatureId !== featureId) {
                    map.setFeatureState(
                        { source: 'countries', id: hoveredFeatureId },
                        { hover: false }
                    );
                }

                hoveredFeatureId = featureId;

                // Set hover state
                map.setFeatureState(
                    { source: 'countries', id: hoveredFeatureId },
                    { hover: true }
                );

                // Show and update tooltip
                const feature = e.features[0];
                const countryData = countryDataMap.get(hoveredFeatureId);

                if (countryData) {
                    document.getElementById('tooltip-country').textContent = countryData.name;

                    // Show last 5 years of data
                    const years = ['2021', '2022', '2023', '2024', '2025'];
                    let html = '';

                    years.forEach(year => {
                        const value = countryData.data[year];
                        if (value !== undefined) {
                            html += `
                                <div class="tooltip-row">
                                    <span class="tooltip-year">${year}</span>
                                    <span class="tooltip-value">$${formatCurrency(value)}</span>
                                </div>
                            `;
                        }
                    });

                    document.getElementById('tooltip-data').innerHTML = html;
                    tooltip.style.display = 'block';
                }

                // Update tooltip position
                tooltip.style.left = (e.originalEvent.pageX + 15) + 'px';
                tooltip.style.top = (e.originalEvent.pageY + 15) + 'px';
            }
        });

        map.on('mouseleave', 'countries-fill', function() {
            if (hoveredFeatureId !== null) {
                map.setFeatureState(
                    { source: 'countries', id: hoveredFeatureId },
                    { hover: false }
                );
            }
            hoveredFeatureId = null;
            tooltip.style.display = 'none';
        });

        // Update tooltip position on mouse move
        document.addEventListener('mousemove', function(e) {
            if (tooltip.style.display === 'block') {
                tooltip.style.left = (e.pageX + 15) + 'px';
                tooltip.style.top = (e.pageY + 15) + 'px';
            }
        });
    });
</script>

</body>
</html>
